import org.ajoberstar.gradle.git.release.opinion.Strategies

import br.lnls.dig.gradle.updatesemvermacrostask.UpdateSemVerMacrosTask

plugins {
    id 'org.ajoberstar.grgit' version '1.7.1'
    id 'org.ajoberstar.release-opinion' version '1.7.1'
}

apply plugin: com.janitovff.grgit.config.GitConfigPlugin

model {
    components {
        revision(NativeLibrarySpec) {
            sources {
                c {
                    exportedHeaders.srcDir 'include'

                    lib project: ':libs:convc', library: 'convc'
                    lib project: ':libs:errhand', library: 'errhand'
                    lib project: ':libs:hutils', library: 'hutils'
                }
            }

            binaries.all {
                cCompiler.define "GIT_REVISION=\"$project.version\""
                cCompiler.define "GIT_USER_NAME=\"$gitConfig.user.name\""
                cCompiler.define "GIT_USER_EMAIL=\"$gitConfig.user.email\""
            }
        }
    }
}

release {
    versionStrategy Strategies.FINAL.copyWith(
        name: 'ci_release',
        stages: ['ci_release'] as SortedSet,
        allowDirtyRepo: true
    )
}

task updateVersionMacros(type: UpdateSemVerMacrosTask) {
    macroPrefix 'HALCS_CLIENT_VERSION_'
    file project.file('include/revision.h')
}
